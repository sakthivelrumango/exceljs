{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-writer.js"],"names":["fs","require","Archiver","StreamBuf","RelType","StylesXform","SharedStrings","DefinedNames","CoreXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","SharedStringsXform","WorksheetWriter","theme1Xml","WorkbookWriter","options","created","Date","modified","creator","lastModifiedBy","lastPrinted","useSharedStrings","sharedStrings","styles","useStyles","Mock","_definedNames","_worksheets","views","zipOptions","zip","media","commentRefs","stream","filename","createWriteStream","pipe","promise","Promise","all","addThemes","addOfficeRels","path","bufSize","batch","append","name","on","emit","commitWorksheet","worksheet","committed","resolve","commit","promises","map","length","_commitWorksheets","addContentTypes","addApp","addCore","addSharedStrings","addStyles","addWorkbookRels","addWorkbook","_finalize","undefined","tabColor","console","trace","properties","Object","assign","id","nextId","workbook","state","pageSetup","autoFilter","find","xml","xform","toXml","Id","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","model","worksheets","filter","Boolean","coreXform","count","sharedStringsXform","relationships","Styles","Theme","push","forEach","rId","Worksheet","definedNames","calcProperties","prepare","reject","finalize","i","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\nconst Archiver = require('archiver');\n\nconst StreamBuf = require('../../utils/stream-buf');\n\nconst RelType = require('../../xlsx/rel-type');\nconst StylesXform = require('../../xlsx/xform/style/styles-xform');\nconst SharedStrings = require('../../utils/shared-strings');\nconst DefinedNames = require('../../doc/defined-names');\n\nconst CoreXform = require('../../xlsx/xform/core/core-xform');\nconst RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\nconst ContentTypesXform = require('../../xlsx/xform/core/content-types-xform');\nconst AppXform = require('../../xlsx/xform/core/app-xform');\nconst WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\nconst SharedStringsXform = require('../../xlsx/xform/strings/shared-strings-xform');\n\nconst WorksheetWriter = require('./worksheet-writer');\n\nconst theme1Xml = require('../../xlsx/xml/theme1.js');\n\nclass WorkbookWriter {\n  constructor(options) {\n    options = options || {};\n\n    this.created = options.created || new Date();\n    this.modified = options.modified || this.created;\n    this.creator = options.creator || 'ExcelJS';\n    this.lastModifiedBy = options.lastModifiedBy || 'ExcelJS';\n    this.lastPrinted = options.lastPrinted;\n\n    // using shared strings creates a smaller xlsx file but may use more memory\n    this.useSharedStrings = options.useSharedStrings || false;\n    this.sharedStrings = new SharedStrings();\n\n    // style manager\n    this.styles = options.useStyles ? new StylesXform(true) : new StylesXform.Mock(true);\n\n    // defined names\n    this._definedNames = new DefinedNames();\n\n    this._worksheets = [];\n    this.views = [];\n\n    this.zipOptions = options.zip;\n\n    this.media = [];\n    this.commentRefs = [];\n\n    this.zip = Archiver('zip', this.zipOptions);\n    if (options.stream) {\n      this.stream = options.stream;\n    } else if (options.filename) {\n      this.stream = fs.createWriteStream(options.filename);\n    } else {\n      this.stream = new StreamBuf();\n    }\n    this.zip.pipe(this.stream);\n\n    // these bits can be added right now\n    this.promise = Promise.all([this.addThemes(), this.addOfficeRels()]);\n  }\n\n  get definedNames() {\n    return this._definedNames;\n  }\n\n  _openStream(path) {\n    const stream = new StreamBuf({bufSize: 65536, batch: true});\n    this.zip.append(stream, {name: path});\n    stream.on('finish', () => {\n      stream.emit('zipped');\n    });\n    return stream;\n  }\n\n  _commitWorksheets() {\n    const commitWorksheet = function(worksheet) {\n      if (!worksheet.committed) {\n        return new Promise(resolve => {\n          worksheet.stream.on('zipped', () => {\n            resolve();\n          });\n          worksheet.commit();\n        });\n      }\n      return Promise.resolve();\n    };\n    // if there are any uncommitted worksheets, commit them now and wait\n    const promises = this._worksheets.map(commitWorksheet);\n    if (promises.length) {\n      return Promise.all(promises);\n    }\n    return Promise.resolve();\n  }\n\n  async commit() {\n    // commit all worksheets, then add suplimentary files\n    await this.promise;\n    await this._commitWorksheets();\n    await Promise.all([this.addContentTypes(), this.addApp(), this.addCore(), this.addSharedStrings(), this.addStyles(), this.addWorkbookRels()]);\n    await this.addWorkbook();\n    return this._finalize();\n  }\n\n  get nextId() {\n    // find the next unique spot to add worksheet\n    let i;\n    for (i = 1; i < this._worksheets.length; i++) {\n      if (!this._worksheets[i]) {\n        return i;\n      }\n    }\n    return this._worksheets.length || 1;\n  }\n\n  addWorksheet(name, options) {\n    // it's possible to add a worksheet with different than default\n    // shared string handling\n    // in fact, it's even possible to switch it mid-sheet\n    options = options || {};\n    const useSharedStrings = options.useSharedStrings !== undefined ? options.useSharedStrings : this.useSharedStrings;\n\n    if (options.tabColor) {\n      // eslint-disable-next-line no-console\n      console.trace('tabColor option has moved to { properties: tabColor: {...} }');\n      options.properties = Object.assign(\n        {\n          tabColor: options.tabColor,\n        },\n        options.properties\n      );\n    }\n\n    const id = this.nextId;\n    name = name || `sheet${id}`;\n\n    const worksheet = new WorksheetWriter({\n      id,\n      name,\n      workbook: this,\n      useSharedStrings,\n      properties: options.properties,\n      state: options.state,\n      pageSetup: options.pageSetup,\n      views: options.views,\n      autoFilter: options.autoFilter,\n    });\n\n    this._worksheets[id] = worksheet;\n    return worksheet;\n  }\n\n  getWorksheet(id) {\n    if (id === undefined) {\n      return this._worksheets.find(() => true);\n    }\n    if (typeof id === 'number') {\n      return this._worksheets[id];\n    }\n    if (typeof id === 'string') {\n      return this._worksheets.find(worksheet => worksheet && worksheet.name === id);\n    }\n    return undefined;\n  }\n\n  addStyles() {\n    return new Promise(resolve => {\n      this.zip.append(this.styles.xml, {name: 'xl/styles.xml'});\n      resolve();\n    });\n  }\n\n  addThemes() {\n    return new Promise(resolve => {\n      this.zip.append(theme1Xml, {name: 'xl/theme/theme1.xml'});\n      resolve();\n    });\n  }\n\n  addOfficeRels() {\n    return new Promise(resolve => {\n      const xform = new RelationshipsXform();\n      const xml = xform.toXml([\n        {Id: 'rId1', Type: RelType.OfficeDocument, Target: 'xl/workbook.xml'},\n        {Id: 'rId2', Type: RelType.CoreProperties, Target: 'docProps/core.xml'},\n        {Id: 'rId3', Type: RelType.ExtenderProperties, Target: 'docProps/app.xml'},\n      ]);\n      this.zip.append(xml, {name: '/_rels/.rels'});\n      resolve();\n    });\n  }\n\n  addContentTypes() {\n    return new Promise(resolve => {\n      const model = {\n        worksheets: this._worksheets.filter(Boolean),\n        sharedStrings: this.sharedStrings,\n        commentRefs: this.commentRefs,\n      };\n      const xform = new ContentTypesXform();\n      const xml = xform.toXml(model);\n      this.zip.append(xml, {name: '[Content_Types].xml'});\n      resolve();\n    });\n  }\n\n  addApp() {\n    return new Promise(resolve => {\n      const model = {\n        worksheets: this._worksheets.filter(Boolean),\n      };\n      const xform = new AppXform();\n      const xml = xform.toXml(model);\n      this.zip.append(xml, {name: 'docProps/app.xml'});\n      resolve();\n    });\n  }\n\n  addCore() {\n    return new Promise(resolve => {\n      const coreXform = new CoreXform();\n      const xml = coreXform.toXml(this);\n      this.zip.append(xml, {name: 'docProps/core.xml'});\n      resolve();\n    });\n  }\n\n  addSharedStrings() {\n    if (this.sharedStrings.count) {\n      return new Promise(resolve => {\n        const sharedStringsXform = new SharedStringsXform();\n        const xml = sharedStringsXform.toXml(this.sharedStrings);\n        this.zip.append(xml, {name: '/xl/sharedStrings.xml'});\n        resolve();\n      });\n    }\n    return Promise.resolve();\n  }\n\n  addWorkbookRels() {\n    let count = 1;\n    const relationships = [\n      {Id: `rId${count++}`, Type: RelType.Styles, Target: 'styles.xml'},\n      {Id: `rId${count++}`, Type: RelType.Theme, Target: 'theme/theme1.xml'},\n    ];\n    if (this.sharedStrings.count) {\n      relationships.push({Id: `rId${count++}`, Type: RelType.SharedStrings, Target: 'sharedStrings.xml'});\n    }\n    this._worksheets.forEach(worksheet => {\n      if (worksheet) {\n        worksheet.rId = `rId${count++}`;\n        relationships.push({Id: worksheet.rId, Type: RelType.Worksheet, Target: `worksheets/sheet${worksheet.id}.xml`});\n      }\n    });\n    return new Promise(resolve => {\n      const xform = new RelationshipsXform();\n      const xml = xform.toXml(relationships);\n      this.zip.append(xml, {name: '/xl/_rels/workbook.xml.rels'});\n      resolve();\n    });\n  }\n\n  addWorkbook() {\n    const {zip} = this;\n    const model = {\n      worksheets: this._worksheets.filter(Boolean),\n      definedNames: this._definedNames.model,\n      views: this.views,\n      properties: {},\n      calcProperties: {},\n    };\n\n    return new Promise(resolve => {\n      const xform = new WorkbookXform();\n      xform.prepare(model);\n      zip.append(xform.toXml(model), {name: '/xl/workbook.xml'});\n      resolve();\n    });\n  }\n\n  _finalize() {\n    return new Promise((resolve, reject) => {\n      this.stream.on('error', reject);\n      this.stream.on('finish', () => {\n        resolve(this);\n      });\n      this.zip.on('error', reject);\n\n      this.zip.finalize();\n    });\n  }\n}\n\nmodule.exports = WorkbookWriter;\n"],"file":"workbook-writer.js"}